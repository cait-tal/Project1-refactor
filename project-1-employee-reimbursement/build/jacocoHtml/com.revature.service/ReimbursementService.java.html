<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReimbursementService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project-1-employee-reimbursement</a> &gt; <a href="index.source.html" class="el_package">com.revature.service</a> &gt; <span class="el_source">ReimbursementService.java</span></div><h1>ReimbursementService.java</h1><pre class="source lang-java linenums">package com.revature.service;

import com.revature.dao.ReimbursementDao;
import com.revature.dto.AddReimbursementDTO;
import com.revature.dto.ResponseReimbursementDTO;
import com.revature.dto.UpdateReimbursementDTO;
import com.revature.dto.UpdateReimbursementStatusDTO;
import com.revature.exception.*;
import com.revature.model.Reimbursement;
import com.revature.utility.UploadImageUtility;
import io.javalin.http.UploadedFile;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.naming.SizeLimitExceededException;
import java.io.IOException;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.List;
import java.util.TimeZone;

public class ReimbursementService {
<span class="pc" id="L27">    Logger logger = LoggerFactory.getLogger(ReimbursementService.class);</span>


    private final ReimbursementDao reimbursementDao;
    private final UploadImageUtility uploadImageUtility;

<span class="nc" id="L33">    public ReimbursementService() {</span>
<span class="nc" id="L34">        this.reimbursementDao = new ReimbursementDao();</span>
<span class="nc" id="L35">        this.uploadImageUtility = new UploadImageUtility();</span>

<span class="nc" id="L37">    }</span>
<span class="fc" id="L38">    public ReimbursementService(ReimbursementDao mockDao, UploadImageUtility mockUploadImageUtility) {</span>
<span class="fc" id="L39">        this.reimbursementDao = mockDao;</span>
<span class="fc" id="L40">        this.uploadImageUtility = mockUploadImageUtility;</span>
<span class="fc" id="L41">    }</span>

    // C
    public ResponseReimbursementDTO addReimbursement(AddReimbursementDTO dto) throws SQLException, IOException, SizeLimitExceededException, InvalidFileTypeException, InvalidJsonBodyProvided {

<span class="fc" id="L46">        AddReimbursementDTO sanitizedDto = sanitizeNewReimbursement(dto);</span>
        // Add timestamp
<span class="fc" id="L48">        Instant instant = Instant.now();</span>
<span class="fc" id="L49">        ZoneId z = ZoneId.of(&quot;America/New_York&quot;);</span>
<span class="fc" id="L50">        ZonedDateTime zdt = instant.atZone(z);</span>
<span class="fc" id="L51">        Timestamp submitted = Timestamp.from(zdt.toInstant());</span>
<span class="fc" id="L52">        sanitizedDto.setReimbSubmitted(submitted);</span>

        // Get URL for image
<span class="fc" id="L55">        UploadedFile uploadedImage = sanitizedDto.getReimbReceiptImage();</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (uploadedImage.getSize() &gt; 10000000) {</span>
<span class="fc" id="L57">            throw new SizeLimitExceededException(&quot;File size exceeded limit of 10MB. Uploaded File Size: &quot; + uploadedImage.getSize());</span>
        }
<span class="pc bpc" id="L59" title="2 of 6 branches missed.">        if (!uploadedImage.getContentType().equals(&quot;image/png&quot;) &amp;&amp; !uploadedImage.getContentType().equals(&quot;image/jpg&quot;) &amp;&amp; !uploadedImage.getContentType().equals(&quot;image/jpeg&quot;)) {</span>
<span class="fc" id="L60">            throw new InvalidFileTypeException(&quot;Invalid file type for uploaded image. Accepted files: .png .jpg .jpeg&quot;);</span>
        }

<span class="fc" id="L63">        String url = uploadImageUtility.uploadImage(uploadedImage);</span>


        // Add the reimbursement
<span class="fc" id="L67">        logger.info(&quot;User &quot; + dto.getReimbAuthor() + &quot; added a reimbursement.&quot;);</span>
<span class="fc" id="L68">        return reimbursementDao.addReimbursement(sanitizedDto, url);</span>
    }

    // R
    public Reimbursement getReimbursementById(String reimbId) throws SQLException, ReimbursementDoesNotExist {
        try {
<span class="fc" id="L74">            int rId = Integer.parseInt(reimbId);</span>
<span class="fc" id="L75">            Reimbursement reimbursement = reimbursementDao.getReimbursementById(rId);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (reimbursement == null) {</span>
<span class="fc" id="L77">                throw new ReimbursementDoesNotExist(&quot;A reimbursement with an id of &quot; + rId + &quot; does not exist at this time.&quot;);</span>
            }
<span class="fc" id="L79">            logger.info(&quot;User requested reimbursement of id &quot; + reimbId + &quot;.&quot;);</span>
<span class="fc" id="L80">            return reimbursement;</span>
<span class="fc" id="L81">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L82">            throw new IllegalArgumentException(&quot;Invalid integer given for request.&quot;);</span>
        }
    }

    public List&lt;ResponseReimbursementDTO&gt; getReimbursementsByUser(String userId) throws SQLException {
        try {
<span class="fc" id="L88">            int uId = Integer.parseInt(userId);</span>
<span class="fc" id="L89">            logger.info(&quot;User requested all reimbursements for &quot; + userId + &quot;.&quot;);</span>
<span class="fc" id="L90">            return reimbursementDao.getReimbursementsByUser(uId);</span>
<span class="fc" id="L91">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L92">            throw new IllegalArgumentException(&quot;Invalid integer given for request.&quot;);</span>
        }
    }

    public List&lt;ResponseReimbursementDTO&gt; getReimbursementsByUserAndStatus(String userId, String currentStatus) throws SQLException, InvalidQueryParamProvided {
        try {
<span class="fc" id="L98">            int uId = Integer.parseInt(userId);</span>
<span class="fc" id="L99">            String status = validateStatus(currentStatus);</span>
<span class="fc" id="L100">            logger.info(&quot;User requested all &quot; + status + &quot; reimbursements for user &quot; + userId + &quot;.&quot;);</span>
<span class="fc" id="L101">            return reimbursementDao.getReimbursementsByUserAndStatus(uId, status);</span>
<span class="fc" id="L102">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L103">            throw new IllegalArgumentException(&quot;Invalid integer given for the request.&quot;);</span>
        }
    }

    public List&lt;ResponseReimbursementDTO&gt; getReimbursementsByDepartment(String department) throws SQLException, InvalidQueryParamProvided {
<span class="fc" id="L108">        String dept = validateDepartment(department);</span>
<span class="fc" id="L109">        logger.info(&quot;User requested all reimbursements for the &quot; + dept + &quot; department.&quot;);</span>
<span class="fc" id="L110">        return reimbursementDao.getReimbursementsByDepartment(dept);</span>
    }
    public List&lt;ResponseReimbursementDTO&gt; getAllReimbursementsByStatus(String status) throws SQLException, InvalidQueryParamProvided {
<span class="fc" id="L113">        String stat = validateStatus(status);</span>
<span class="fc" id="L114">        logger.info(&quot;User requested all &quot; + stat +&quot; reimbursements.&quot;);</span>
<span class="fc" id="L115">        return reimbursementDao.getAllReimbursementsByStatus(stat);</span>
    }

    public List&lt;ResponseReimbursementDTO&gt; getAllReimbursementsByStatusAndDepartment(String status, String department) throws SQLException, InvalidQueryParamProvided {
<span class="fc" id="L119">        String dept = validateDepartment(department);</span>
<span class="fc" id="L120">        String stat = validateStatus(status);</span>

<span class="fc" id="L122">        logger.info(&quot;User requested all &quot; + stat + &quot;reimbursements from the &quot; + dept + &quot; department.&quot;);</span>
<span class="fc" id="L123">        return reimbursementDao.getAllReimbursementsByStatusAndDepartment(stat, dept);</span>
    }

    public List&lt;ResponseReimbursementDTO&gt; getAllReimbursements() throws SQLException {
<span class="fc" id="L127">        logger.info(&quot;User requested all reimbursements.&quot;);</span>
<span class="fc" id="L128">        return reimbursementDao.getAllReimbursements();</span>
    }

    public Reimbursement editUnresolvedReimbursement(String reimbId, UpdateReimbursementDTO dto) throws SQLException, ReimbursementAlreadyResolved, ReimbursementDoesNotExist, InvalidJsonBodyProvided {

<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (!(getReimbursementById(reimbId).getStatus().equals(&quot;Pending&quot;))) {</span>
<span class="fc" id="L134">            throw new ReimbursementAlreadyResolved(&quot;This reimbursement has already been approved or denied. Unable to make changes at this time.&quot;);</span>
        }
<span class="fc" id="L136">        int rId = Integer.parseInt(reimbId);</span>
<span class="fc" id="L137">        UpdateReimbursementDTO sanitizedDto = sanitizeUpdateReimbursement(dto);</span>

<span class="fc" id="L139">        logger.info(&quot;User edited reimbursement with an id of &quot; + reimbId + &quot;.&quot;);</span>
<span class="fc" id="L140">        return reimbursementDao.editUnresolvedReimbursement(rId, sanitizedDto);</span>
    }

    public boolean updateReimbursementStatus(UpdateReimbursementStatusDTO dto, String reimbId) throws SQLException, ReimbursementAlreadyResolved, ReimbursementDoesNotExist, InvalidJsonBodyProvided {

<span class="fc bfc" id="L145" title="All 2 branches covered.">        if(!(getReimbursementById(reimbId).getStatus().equals(&quot;Pending&quot;))) {</span>
<span class="fc" id="L146">            throw new ReimbursementAlreadyResolved(&quot;This reimbursement has already been approved or denied. Unable to make changes at this time.&quot;);</span>
        }
<span class="pc bpc" id="L148" title="1 of 4 branches missed.">        if (!(dto.getStatusId() == 101 || dto.getStatusId() == 303)) {</span>
<span class="fc" id="L149">            throw new InvalidJsonBodyProvided(&quot;You must provide an appropriate status code to update.&quot;);</span>
        }
<span class="fc" id="L151">        int rId = Integer.parseInt(reimbId);</span>
<span class="fc" id="L152">        TimeZone.setDefault(TimeZone.getTimeZone(&quot;EST&quot;));</span>
<span class="fc" id="L153">        Timestamp submitted = Timestamp.valueOf(LocalDateTime.now());</span>
<span class="fc" id="L154">        dto.setTimestamp(submitted);</span>
<span class="fc" id="L155">        logger.info(&quot;User updated the status of reimbursement with an id of &quot; + reimbId + &quot; to &quot; + dto.getStatusId() + &quot;.&quot;);</span>
<span class="fc" id="L156">        return reimbursementDao.updateReimbursementStatus(dto, rId);</span>
    }

    public boolean deleteUnresolvedReimbursement(String reimbId) throws SQLException, ReimbursementAlreadyResolved, ReimbursementDoesNotExist {
<span class="fc" id="L160">        Reimbursement reimbToDelete = getReimbursementById(reimbId);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if(!(reimbToDelete.getStatus().equals(&quot;Pending&quot;))) {</span>
<span class="fc" id="L162">            throw new ReimbursementAlreadyResolved(&quot;This reimbursement has already been approved or denied. Unable to make changes at this time.&quot;);</span>
        }
<span class="fc" id="L164">        int rId = Integer.parseInt(reimbId);</span>
<span class="fc" id="L165">        String imageToDelete = reimbToDelete.getReceiptUrl().split(&quot;/&quot;)[4];</span>
<span class="fc" id="L166">        uploadImageUtility.deleteImage(imageToDelete);</span>
<span class="fc" id="L167">        logger.info(&quot;User deleted a reimbursement with an id of &quot; + rId + &quot;.&quot;);</span>
<span class="fc" id="L168">        return reimbursementDao.deleteUnresolvedReimbursement(rId);</span>
    }

    public String validateDepartment(String department) throws InvalidQueryParamProvided {
<span class="fc" id="L172">        String dept = department.toLowerCase();</span>
<span class="pc bpc" id="L173" title="7 of 14 branches missed.">        if (!(dept.equals(&quot;management&quot;) || dept.equals(&quot;finance&quot;) || dept.equals(&quot;hr&quot;) &amp;&amp; dept.equals(&quot;it&quot;) || dept.equals(&quot;marketing&quot;) || dept.equals(&quot;sales&quot;) || dept.equals(&quot;quality assurance&quot;))) {</span>
<span class="fc" id="L174">            throw new InvalidQueryParamProvided(&quot;Provided department is not a valid department. Input: &quot; + department);</span>
        }

<span class="fc" id="L177">        return dept.substring(0, 1).toUpperCase() + dept.substring(1);</span>
    }

    public String validateStatus(String status) throws InvalidQueryParamProvided {
<span class="fc" id="L181">        String stat = status.toLowerCase();</span>
<span class="fc bfc" id="L182" title="All 6 branches covered.">        if (!(stat.equals(&quot;pending&quot;) || stat.equals(&quot;approved&quot;) || stat.equals(&quot;rejected&quot;)))  {</span>
<span class="fc" id="L183">            throw new InvalidQueryParamProvided(&quot;Provided status is not a valid status. Input: &quot; + status);</span>
        }
<span class="fc" id="L185">        return stat.substring(0, 1).toUpperCase() + stat.substring(1);</span>
    }

    public AddReimbursementDTO sanitizeNewReimbursement(AddReimbursementDTO dto) throws InvalidJsonBodyProvided {
<span class="fc" id="L189">        double amount = dto.getReimbAmount();</span>
<span class="fc" id="L190">        String descrip = dto.getReimbDescription().trim();</span>
<span class="fc" id="L191">        int type = dto.getReimbType();</span>
<span class="pc bpc" id="L192" title="3 of 8 branches missed.">        if (!(type == 10 || type == 20 || type == 30 || type == 40)) {</span>
<span class="fc" id="L193">            throw new InvalidJsonBodyProvided(&quot;Invalid type id provided. Input: &quot; + type);</span>
        }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (amount &lt; 0) {</span>
<span class="nc" id="L196">            throw new InvalidJsonBodyProvided(&quot;Amount provided cannot be negative. Input: &quot; + amount);</span>
        }
<span class="fc" id="L198">        dto.setReimbDescription(descrip);</span>
<span class="fc" id="L199">        return dto;</span>
    }

    public UpdateReimbursementDTO sanitizeUpdateReimbursement(UpdateReimbursementDTO dto) throws InvalidJsonBodyProvided {
<span class="fc" id="L203">        double amount = dto.getAmount();</span>

<span class="fc" id="L205">        int type = dto.getType();</span>
<span class="pc bpc" id="L206" title="3 of 8 branches missed.">        if (!(type == 10 || type == 20 || type == 30 || type == 40)) {</span>
<span class="fc" id="L207">            throw new InvalidJsonBodyProvided(&quot;Invalid type id provided. Input: &quot; + type);</span>
        }
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (amount &lt; 0) {</span>
<span class="fc" id="L210">            throw new InvalidJsonBodyProvided(&quot;Amount provided cannot be negative. Input: &quot; + amount);</span>
        }
<span class="fc" id="L212">        String descrip = dto.getDescription().trim();</span>
<span class="fc" id="L213">        dto.setDescription(descrip);</span>
<span class="fc" id="L214">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>